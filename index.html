<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meeting 41 CE&STT - Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --navy-blue: #001a33; 
            --gold-accent: #d4af37; 
            --success-color: #28a745;
            --orange-theme: #f39c12;
            --danger-red: #dc3545;
            --excel-green: #1d6f42;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--navy-blue);
            margin: 0; padding: 10px;
            display: flex; justify-content: center; min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            padding: 25px; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            width: 100%; max-width: 480px; text-align: center;
            border: 3px solid var(--gold-accent);
            height: fit-content; margin-top: 20px;
            position: relative;
        }

        .header-section { margin-bottom: 20px; }
        .main-title { font-size: 2rem; font-weight: 800; color: var(--gold-accent); margin: 0; line-height: 1.2; }

        input[type="text"], input[type="tel"], textarea {
            width: 90%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 2px solid #ddd; font-family: 'Kanit'; font-size: 1rem;
        }

        button { padding: 12px 20px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--navy-blue); color: white; width: 95%; font-size: 1.1rem; border: 1px solid var(--gold-accent); }
        .btn-add { background: var(--orange-theme); color: white; width: 100%; font-size: 1.1rem; margin-top: 10px; }
        .btn-save { background: var(--success-color); color: white; width: 100%; margin-top: 10px; }
        
        .btn-excel-small { 
            position: absolute; top: 15px; right: 15px;
            background: var(--excel-green); color: white; 
            padding: 5px 10px; font-size: 0.7rem; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
        }

        .list-item {
            background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 15px;
            text-align: left; border-left: 6px solid var(--orange-theme); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .admin-user-card {
            background: white; padding: 15px; margin: 10px 0; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #ddd;
        }

        .leaderboard-table {
            width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; border-radius: 10px; overflow: hidden; font-size: 0.8rem;
        }
        .leaderboard-table th { background: var(--gold-accent); color: white; padding: 8px; }
        .leaderboard-table td { padding: 8px; border-bottom: 1px solid #eee; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; padding: 10px;
        }

        .admin-del-btn { background: var(--danger-red); color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.7rem; margin-left: 5px; }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô Modal */
        .detail-box { border-bottom: 2px solid #f0f0f0; padding: 15px 0; position: relative; }
        .detail-row { margin-bottom: 4px; font-size: 0.95rem; border-left: 3px solid var(--gold-accent); padding-left: 10px; }
        .detail-label { color: #666; font-weight: bold; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="container">
    <button id="excel-btn" class="btn-excel-small" style="display: none;" onclick="exportToExcel()">üìä Excel</button>

    <div class="header-section">
        <h1 class="main-title">CE&STT QUEST</h1>
        <p style="color: var(--navy-blue); font-weight: bold;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</p>
    </div>

    <hr style="border:0; border-top:2px solid var(--gold-accent); margin: 15px 0;">

    <div id="login-section">
        <input type="text" id="login-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="text" id="login-batch" placeholder="‡∏£‡∏∏‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô CE20)">
        <button class="btn-main" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="user-section" style="display: none;">
        <h3 style="margin:0; color:var(--navy-blue)">‡∏Ñ‡∏∏‡∏ì: <span id="display-name" style="color:var(--orange-theme)"></span></h3>
        <div id="senior-list" style="margin-top: 15px;"></div>
        <button id="add-button" class="btn-add" onclick="showForm()">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà <span id="next-num">1</span></button>
        <button onclick="location.reload()" style="background:#ccc; margin-top:15px; font-size:0.8rem;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="admin-section" style="display: none;">
        <h2 style="color:var(--navy-blue); margin-bottom: 5px;">Admin Dashboard</h2>
        <div style="margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 15px;">
            <h4 style="margin: 0 0 10px 0; color: var(--navy-blue);">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h4>
            <table class="leaderboard-table">
                <thead><tr><th>‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th></tr></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <h4 style="text-align: left; margin: 20px 0 10px 0;">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏£‡∏≠‡∏Å</h4>
        <div id="all-users-list"></div>
        <button onclick="location.reload()" style="background:#666; color:white; margin-top:20px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div id="formModal" class="modal">
    <div style="background:white; padding:20px; border-radius:20px; width:100%; max-width:400px; max-height: 90vh; overflow-y: auto;">
        <h3 style="color:var(--navy-blue); margin-top:0;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</h3>
        <input type="text" id="s-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="text" id="s-nickname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
        <input type="text" id="s-batch" placeholder="‡∏£‡∏∏‡πà‡∏ô CE-STT">
        <input type="tel" id="s-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
        <input type="text" id="s-work" placeholder="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó / ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
        <textarea id="s-intern" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô" rows="3"></textarea>
        <button id="save-btn" class="btn-save" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button onclick="closeForm()" style="background:#ccc; width:100%; margin-top:8px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div id="adminDetailModal" class="modal">
    <div style="background:white; padding:20px; border-radius:20px; width:100%; max-width:400px; max-height: 80vh; overflow-y: auto; text-align: left;">
        <h3 id="admin-view-title" style="color:var(--navy-blue); margin-top:0; border-bottom: 2px solid var(--gold-accent); padding-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
        <div id="admin-view-content"></div>
        <button onclick="closeAdminModal()" style="background:var(--navy-blue); color:white; width:100%; margin-top:15px; border-radius: 10px; width: 100%;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAId-pF0U0hUe6hOxBf5SZu4sBObk2FIIc",
        authDomain: "binggocivil.firebaseapp.com",
        databaseURL: "https://binggocivil-default-rtdb.firebaseio.com",
        projectId: "binggocivil",
        storageBucket: "binggocivil.firebasestorage.app",
        messagingSenderId: "615822572602",
        appId: "1:615822572602:web:5207b9a09174d41daf0903"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = ""; let currentBatch = ""; let mySeniors = [];

    function login() {
        const nameInput = document.getElementById('login-name').value.trim();
        const batchInput = document.getElementById('login-batch').value.trim();
        if (!nameInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠!");
        if (nameInput === "meeting41civil") { showAdmin(); } 
        else { if (!batchInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏∏‡πà‡∏ô!"); currentUser = nameInput; currentBatch = batchInput; loadUserData(); }
    }

    function loadUserData() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('user-section').style.display = 'block';
        document.getElementById('display-name').innerText = currentUser + " (‡∏£‡∏∏‡πà‡∏ô " + currentBatch + ")";
        db.ref('users/' + currentUser).on('value', (snapshot) => {
            const data = snapshot.val();
            mySeniors = (data && data.seniors) ? data.seniors : [];
            renderList();
        });
    }

    function renderList() {
        const listDiv = document.getElementById('senior-list');
        listDiv.innerHTML = "";
        mySeniors.forEach((s, index) => {
            listDiv.innerHTML += `<div class="list-item"><b>${index+1}. ${s.name}</b><br><small>CE${s.batch} | ${s.work}</small></div>`;
        });
        document.getElementById('next-num').innerText = mySeniors.length + 1;
    }

    function showForm() { document.getElementById('formModal').style.display = 'flex'; }
    function closeForm() { document.getElementById('formModal').style.display = 'none'; }
    function closeAdminModal() { document.getElementById('adminDetailModal').style.display = 'none'; }

    function saveData() {
        const sName = document.getElementById('s-name').value.trim();
        if(!sName) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô");
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const newSenior = {
            name: sName, nickname: document.getElementById('s-nickname').value || "-", 
            batch: document.getElementById('s-batch').value || "-",
            phone: document.getElementById('s-phone').value || "-", 
            work: document.getElementById('s-work').value || "-", 
            intern: document.getElementById('s-intern').value || "-"
        };

        const updatedSeniors = [...mySeniors, newSenior];
        db.ref('users/' + currentUser).set({
            name: currentUser, batch: currentBatch, seniors: updatedSeniors, count: updatedSeniors.length
        }).then(() => {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); closeForm();
            document.querySelectorAll('#formModal input, #formModal textarea').forEach(el => el.value = "");
            btn.disabled = false; btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        });
    }

    function showAdmin() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-section').style.display = 'block';
        document.getElementById('excel-btn').style.display = 'block'; 

        db.ref('users').on('value', (snapshot) => {
            const listDiv = document.getElementById('all-users-list');
            const leaderboardBody = document.getElementById('leaderboard-body');
            listDiv.innerHTML = ""; leaderboardBody.innerHTML = "";
            if(!snapshot.exists()) return;
            
            let allUsers = [];
            snapshot.forEach((child) => { allUsers.push(child.val()); });
            let sortedUsers = [...allUsers].sort((a, b) => (b.count || 0) - (a.count || 0));
            sortedUsers.forEach((user, index) => {
                let rank = index < 3 ? ["ü•á","ü•à","ü•â"][index] : index + 1;
                leaderboardBody.innerHTML += `<tr><td>${rank}</td><td>${user.name}</td><td><b>${user.count || 0}</b></td></tr>`;
            });

            allUsers.forEach((user) => {
                const card = document.createElement('div');
                card.className = 'admin-user-card';
                card.innerHTML = `
                    <div style="text-align:left"><b>${user.name} (CE${user.batch})</b><br><small>‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ: ${user.count || 0}</small></div>
                    <div><button onclick="viewDetails('${user.name}')" style="background:var(--navy-blue); color:white; padding:8px; border-radius:8px;">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="deleteUser('${user.name}')" class="admin-del-btn">‡∏•‡∏ö</button></div>`;
                listDiv.appendChild(card);
            });
        });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå ---
    function viewDetails(uName) {
        db.ref('users/' + uName).once('value', (snapshot) => {
            const user = snapshot.val();
            if(!user || !user.seniors) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            
            document.getElementById('admin-view-title').innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢: " + uName;
            const content = document.getElementById('admin-view-content');
            content.innerHTML = "";

            user.seniors.forEach((s, i) => {
                const item = document.createElement('div');
                item.className = 'detail-box';
                item.innerHTML = `
                    <div style="color:var(--orange-theme); font-weight:bold; margin-bottom:10px;">‡∏£‡∏∏‡πà‡∏ô‡∏û‡∏µ‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${i+1}</div>
                    <div class="detail-row"><span class="detail-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span> ${s.name}</div>
                    <div class="detail-row"><span class="detail-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</span> ${s.nickname}</div>
                    <div class="detail-row"><span class="detail-label">‡∏£‡∏∏‡πà‡∏ô:</span> ${s.batch}</div>
                    <div class="detail-row"><span class="detail-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span> ${s.phone}</div>
                    <div class="detail-row"><span class="detail-label">‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</span> ${s.work}</div>
                    <div class="detail-row"><span class="detail-label">‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô:</span> ${s.intern}</div>
                    <button onclick="deleteSeniorRow('${uName}', ${i})" style="position:absolute; right:0; top:10px; background:var(--danger-red); color:white; border-radius:5px; font-size:10px; padding:5px;">‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</button>
                `;
                content.appendChild(item);
            });
            document.getElementById('adminDetailModal').style.display = 'flex';
        });
    }

    function exportToExcel() {
        db.ref('users').once('value', (snapshot) => {
            if (!snapshot.exists()) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            let data = [];
            snapshot.forEach(uSnap => {
                const u = uSnap.val();
                if(u.seniors) u.seniors.forEach(s => {
                    data.push({"‡∏ú‡∏π‡πâ‡∏Å‡∏£‡∏≠‡∏Å": u.name, "‡∏ú‡∏π‡πâ‡∏Å‡∏£‡∏≠‡∏Å(‡∏£‡∏∏‡πà‡∏ô)": u.batch, "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô": s.name, "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô": s.nickname, "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô(‡∏£‡∏∏‡πà‡∏ô)": s.batch, "‡πÇ‡∏ó‡∏£": s.phone, "‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô": s.work, "‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô": s.intern});
                });
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, "Meeting41_Full_Data.xlsx");
        });
    }

    function deleteUser(u) { if(confirm(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á ${u}?`)) db.ref('users/' + u).remove(); }

    function deleteSeniorRow(u, i) {
        if(confirm("‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?")) {
            db.ref('users/' + u).once('value', (s) => {
                let user = s.val(); user.seniors.splice(i, 1);
                db.ref('users/' + u).update({ seniors: user.seniors, count: user.seniors.length }).then(() => {
                    // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    closeAdminModal();
                    if(user.seniors.length > 0) viewDetails(u);
                });
            });
        }
    }
</script>
</body>
</html>
